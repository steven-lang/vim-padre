steps:
  - template: install-rust.yml

  - script: |
      sudo add-apt-repository -y ppa:jonathonf/vim
      sudo apt-get update
      sudo apt-get install -y vim
      mkdir -p ~/.vim/autoload ~/.vim/bundle
      curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim
      git clone https://github.com/junegunn/vader.vim ~/.vim/bundle/vader
      ln -s `pwd` ~/.vim/bundle/padre
      cp test/vimrc ~/.vimrc
    displayName: Install VIM and plugins

  - bash: |
      test/pythonx/test_prog.py
      success=0
      fail=0
      for i in {1..100}; do
          vim '+Vader! test/unit/test_job.vader'
          if [[ $? == 0 ]]; then
              success=$((${success} + 1))
          else
              fail=$((${success} + 1))
          fi
      done
      echo "Ran test 100 times and got ${success} successes and ${fail} failures"
    displayName: Check frequency of passing/failing test

  - bash: |
      vim '+Vader! test/unit/*.vader'
    displayName: Run VIM unit tests

  - script: |
      sudo apt-get install -y lldb gcc
      cd test/progs
      gcc -g -o test_prog test_prog.c test_func.c
    displayName: Install lldb and build essentials and compile test program

  - script: |
      cd padre
      cargo build
    displayName: Compile Padre CLI

  - bash: |
      vim '+Vader! test/integration/*.vader'
    displayName: Run VIM integration tests
