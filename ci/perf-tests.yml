steps:
  - template: install-rust.yml

  - script: |
      sudo apt-get install software-properties-common python3 python3-pip python3-setuptools
      pip3 install wheel
      pip3 install locustio
    displayName: Install python dependencies

  - script: |
      sudo apt-get install -y lldb-5.0 gcc
      sudo ln -s /usr/bin/lldb-5.0 /usr/bin/lldb
      sudo ln -s /usr/bin/lldb-server-5.0 /usr/bin/lldb-server
      sudo ln -s /usr/bin/lldb-server-5.0 /usr/lib/llvm-5.0/bin/lldb-server-5.0.0
      gcc -g -O0 -o padre/test_loop test/progs/test_loop.c
    displayName: Install lldb and build essentials and compile test program

  - bash: |
      cd padre
      cargo build
    displayName: Build Padre CLI

  - bash: |
      cd padre
      cargo run -- -d=lldb -t=lldb -- ./test_loop &
      sleep 10
      cd ../
      python test/perf/setup.py
      ~/.local/bin/locust -f test/perf/steptest.py --no-web -c 5 -r 0.05 -t 100
      kill $(jobs -p)
    env:
      RUST_BACKTRACE: 1
    displayName: Run Padre CLI and perf test
